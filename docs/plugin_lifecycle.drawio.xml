<?xml version="1.0" encoding="UTF-8"?>
<mxfile>
  <diagram name="OpenClaw-Cortex Plugin Lifecycle" id="lifecycle">
    <mxGraphModel dx="1400" dy="900" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1600" pageHeight="1200" math="0" shadow="0">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>

        <!-- Title -->
        <mxCell id="title" value="OpenClaw + Cortex Memory Plugin  -  Full Lifecycle" style="text;fontSize=22;fontStyle=1;align=center;verticalAlign=middle;fillColor=none;strokeColor=none;fontColor=#1a1a2e;" vertex="1" parent="1">
          <mxGeometry x="400" y="20" width="800" height="40" as="geometry"/>
        </mxCell>

        <!-- Phase Labels -->
        <mxCell id="phase1_label" value="1. STARTUP" style="text;fontSize=14;fontStyle=1;align=left;verticalAlign=middle;fillColor=none;strokeColor=none;fontColor=#6c5ce7;" vertex="1" parent="1">
          <mxGeometry x="40" y="80" width="120" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="phase2_label" value="2. CONVERSATION LOOP" style="text;fontSize=14;fontStyle=1;align=left;verticalAlign=middle;fillColor=none;strokeColor=none;fontColor=#00b894;" vertex="1" parent="1">
          <mxGeometry x="40" y="280" width="250" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="phase3_label" value="3. BACKGROUND SYNC" style="text;fontSize=14;fontStyle=1;align=left;verticalAlign=middle;fillColor=none;strokeColor=none;fontColor=#e17055;" vertex="1" parent="1">
          <mxGeometry x="40" y="700" width="220" height="30" as="geometry"/>
        </mxCell>
        <mxCell id="phase4_label" value="4. SHUTDOWN" style="text;fontSize=14;fontStyle=1;align=left;verticalAlign=middle;fillColor=none;strokeColor=none;fontColor=#636e72;" vertex="1" parent="1">
          <mxGeometry x="40" y="1040" width="160" height="30" as="geometry"/>
        </mxCell>

        <!-- PHASE 1: STARTUP -->
        <mxCell id="startup_bg" value="" style="rounded=1;whiteSpace=wrap;fillColor=#f8f0ff;strokeColor=#6c5ce7;strokeWidth=1;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="110" width="1520" height="150" as="geometry"/>
        </mxCell>

        <mxCell id="config" value="Plugin Config&#xa;&#xa;apiKey, baseUrl&#xa;recallMode, queryType&#xa;namespace, fileSync" style="rounded=1;whiteSpace=wrap;fillColor=#6c5ce7;fontColor=#ffffff;strokeColor=none;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="80" y="130" width="170" height="100" as="geometry"/>
        </mxCell>

        <mxCell id="zod" value="Zod Validate&#xa;&#xa;HTTPS enforced&#xa;Sane defaults applied" style="rounded=1;whiteSpace=wrap;fillColor=#a29bfe;fontColor=#ffffff;strokeColor=none;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="330" y="140" width="160" height="80" as="geometry"/>
        </mxCell>

        <mxCell id="client_init" value="CortexClient&#xa;&#xa;new CortexClient(&#xa;  baseUrl, apiKey)" style="rounded=1;whiteSpace=wrap;fillColor=#a29bfe;fontColor=#ffffff;strokeColor=none;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="570" y="140" width="160" height="80" as="geometry"/>
        </mxCell>

        <mxCell id="health" value="Health Check&#xa;&#xa;GET /health&#xa;async, non-blocking" style="rounded=1;whiteSpace=wrap;fillColor=#a29bfe;fontColor=#ffffff;strokeColor=none;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="810" y="140" width="160" height="80" as="geometry"/>
        </mxCell>

        <mxCell id="hooks_reg" value="Register Hooks&#xa;&#xa;before_agent_start&#xa;agent_end&#xa;+ background services" style="rounded=1;whiteSpace=wrap;fillColor=#6c5ce7;fontColor=#ffffff;strokeColor=none;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="1050" y="130" width="180" height="100" as="geometry"/>
        </mxCell>

        <mxCell id="ready" value="Ready" style="ellipse;whiteSpace=wrap;fillColor=#00b894;fontColor=#ffffff;strokeColor=none;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="1350" y="145" width="90" height="60" as="geometry"/>
        </mxCell>

        <mxCell id="s1" style="edgeStyle=orthogonalEdgeStyle;strokeColor=#6c5ce7;strokeWidth=2;" edge="1" parent="1" source="config" target="zod"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="s2" style="edgeStyle=orthogonalEdgeStyle;strokeColor=#6c5ce7;strokeWidth=2;" edge="1" parent="1" source="zod" target="client_init"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="s3" style="edgeStyle=orthogonalEdgeStyle;strokeColor=#6c5ce7;strokeWidth=2;" edge="1" parent="1" source="client_init" target="health"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="s4" style="edgeStyle=orthogonalEdgeStyle;strokeColor=#6c5ce7;strokeWidth=2;" edge="1" parent="1" source="health" target="hooks_reg"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="s5" style="edgeStyle=orthogonalEdgeStyle;strokeColor=#00b894;strokeWidth=2;" edge="1" parent="1" source="hooks_reg" target="ready"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- PHASE 2: CONVERSATION LOOP -->
        <mxCell id="conv_bg" value="" style="rounded=1;whiteSpace=wrap;fillColor=#f0fff4;strokeColor=#00b894;strokeWidth=1;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="310" width="1520" height="370" as="geometry"/>
        </mxCell>

        <!-- User -->
        <mxCell id="user" value="User&#xa;Types a prompt" style="shape=actor;whiteSpace=wrap;fillColor=#dfe6e9;strokeColor=#636e72;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="80" y="440" width="80" height="100" as="geometry"/>
        </mxCell>

        <!-- Auto-Recall Box -->
        <mxCell id="recall_box" value="" style="rounded=1;whiteSpace=wrap;fillColor=#e8f5e9;strokeColor=#00b894;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="220" y="340" width="360" height="310" as="geometry"/>
        </mxCell>
        <mxCell id="recall_title" value="AUTO-RECALL&#xa;before_agent_start hook" style="text;fontSize=12;fontStyle=1;align=center;fillColor=none;strokeColor=none;fontColor=#00b894;" vertex="1" parent="1">
          <mxGeometry x="300" y="345" width="200" height="40" as="geometry"/>
        </mxCell>

        <mxCell id="cold_gate" value="Cold-Start Gate&#xa;3 failures = 30s&#xa;cooldown" style="rhombus;whiteSpace=wrap;fillColor=#00b894;fontColor=#ffffff;strokeColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="245" y="400" width="150" height="100" as="geometry"/>
        </mxCell>

        <mxCell id="retrieve_call" value="POST /v1/retrieve&#xa;&#xa;query, top_k&#xa;mode, query_type" style="rounded=1;whiteSpace=wrap;fillColor=#00b894;fontColor=#ffffff;strokeColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="245" y="530" width="150" height="70" as="geometry"/>
        </mxCell>

        <mxCell id="format_mem" value="Format Memories&#xa;&#xa;prepend to agent&#xa;context" style="rounded=1;whiteSpace=wrap;fillColor=#00b894;fontColor=#ffffff;strokeColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="415" y="530" width="150" height="70" as="geometry"/>
        </mxCell>

        <mxCell id="cg1" style="strokeColor=#00b894;strokeWidth=1.5;" edge="1" parent="1" source="cold_gate" target="retrieve_call"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="rc1" style="strokeColor=#00b894;strokeWidth=1.5;" edge="1" parent="1" source="retrieve_call" target="format_mem"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- Agent -->
        <mxCell id="agent" value="OpenClaw Agent&#xa;&#xa;Sees recalled memories&#xa;+ user prompt&#xa;&#xa;Generates response" style="rounded=1;whiteSpace=wrap;fillColor=#2d3436;fontColor=#ffffff;strokeColor=none;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="650" y="420" width="200" height="130" as="geometry"/>
        </mxCell>

        <!-- Auto-Capture Box -->
        <mxCell id="capture_box" value="" style="rounded=1;whiteSpace=wrap;fillColor=#e8f5e9;strokeColor=#00b894;strokeWidth=2;" vertex="1" parent="1">
          <mxGeometry x="920" y="340" width="360" height="310" as="geometry"/>
        </mxCell>
        <mxCell id="capture_title" value="AUTO-CAPTURE&#xa;agent_end hook" style="text;fontSize=12;fontStyle=1;align=center;fillColor=none;strokeColor=none;fontColor=#00b894;" vertex="1" parent="1">
          <mxGeometry x="1010" y="345" width="180" height="40" as="geometry"/>
        </mxCell>

        <mxCell id="ingest_conv" value="POST /v1/ingest/&#xa;conversation&#xa;&#xa;messages + session_id&#xa;speaker attribution" style="rounded=1;whiteSpace=wrap;fillColor=#00b894;fontColor=#ffffff;strokeColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="945" y="400" width="160" height="90" as="geometry"/>
        </mxCell>

        <mxCell id="extract" value="Cortex Extracts&#xa;&#xa;Facts, Entities&#xa;Emotions, Insights&#xa;-> graph nodes" style="rounded=1;whiteSpace=wrap;fillColor=#00b894;fontColor=#ffffff;strokeColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1125" y="400" width="140" height="90" as="geometry"/>
        </mxCell>

        <mxCell id="retry_q" value="RetryQueue&#xa;dedup by tag&#xa;on failure" style="rounded=1;whiteSpace=wrap;fillColor=#fdcb6e;fontColor=#2d3436;strokeColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1030" y="530" width="130" height="60" as="geometry"/>
        </mxCell>

        <mxCell id="ic1" style="strokeColor=#00b894;strokeWidth=1.5;" edge="1" parent="1" source="ingest_conv" target="extract"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="ic2" style="strokeColor=#fdcb6e;strokeWidth=1.5;dashed=1;" edge="1" parent="1" source="ingest_conv" target="retry_q"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- Conversation flow arrows -->
        <mxCell id="u1" value="prompt" style="edgeStyle=orthogonalEdgeStyle;strokeColor=#636e72;strokeWidth=2;fontSize=10;" edge="1" parent="1" source="user" target="recall_box"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="r2a" value="context + prompt" style="edgeStyle=orthogonalEdgeStyle;strokeColor=#00b894;strokeWidth=2;fontSize=10;" edge="1" parent="1" source="recall_box" target="agent"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="a2c" value="conversation turn" style="edgeStyle=orthogonalEdgeStyle;strokeColor=#00b894;strokeWidth=2;fontSize=10;" edge="1" parent="1" source="agent" target="capture_box"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- Loop arrow -->
        <mxCell id="loop_arrow" value="next turn" style="edgeStyle=orthogonalEdgeStyle;curved=1;strokeColor=#636e72;strokeWidth=2;dashed=1;fontSize=10;fontStyle=1;" edge="1" parent="1" source="capture_box" target="user">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1100" y="680"/>
              <mxPoint x="120" y="680"/>
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- PHASE 3: BACKGROUND SYNC -->
        <mxCell id="sync_bg" value="" style="rounded=1;whiteSpace=wrap;fillColor=#fff5f0;strokeColor=#e17055;strokeWidth=1;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="730" width="1520" height="280" as="geometry"/>
        </mxCell>

        <!-- File Sync Watcher -->
        <mxCell id="watcher" value="FileSyncWatcher&#xa;&#xa;fs.watch (continuous)&#xa;safePath validation" style="rounded=1;whiteSpace=wrap;fillColor=#e17055;fontColor=#ffffff;strokeColor=none;fontSize=11;" vertex="1" parent="1">
          <mxGeometry x="80" y="770" width="180" height="80" as="geometry"/>
        </mxCell>

        <!-- Three sync sources -->
        <mxCell id="memory_md" value="MEMORY.md&#xa;&#xa;.claude/MEMORY.md&#xa;lineDiff (new lines only)&#xa;2s debounce" style="rounded=1;whiteSpace=wrap;fillColor=#fab1a0;fontColor=#2d3436;strokeColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="340" y="740" width="170" height="80" as="geometry"/>
        </mxCell>

        <mxCell id="daily_logs" value="Daily Logs&#xa;&#xa;.claude/memory/*.md&#xa;incremental offset&#xa;reference_date from filename" style="rounded=1;whiteSpace=wrap;fillColor=#fab1a0;fontColor=#2d3436;strokeColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="340" y="840" width="170" height="80" as="geometry"/>
        </mxCell>

        <mxCell id="transcripts" value="Transcripts&#xa;&#xa;.claude/sessions/*.jsonl&#xa;JSONL parse + clean&#xa;worthIngesting gate" style="rounded=1;whiteSpace=wrap;fillColor=#fab1a0;fontColor=#2d3436;strokeColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="340" y="940" width="170" height="80" as="geometry"/>
        </mxCell>

        <mxCell id="w2m" style="strokeColor=#e17055;strokeWidth=1.5;" edge="1" parent="1" source="watcher" target="memory_md"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="w2d" style="strokeColor=#e17055;strokeWidth=1.5;" edge="1" parent="1" source="watcher" target="daily_logs"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="w2t" style="strokeColor=#e17055;strokeWidth=1.5;" edge="1" parent="1" source="watcher" target="transcripts"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- Ingest endpoints for sync -->
        <mxCell id="ingest_text" value="POST /v1/ingest&#xa;&#xa;text + session_id&#xa;+ reference_date" style="rounded=1;whiteSpace=wrap;fillColor=#e17055;fontColor=#ffffff;strokeColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="620" y="780" width="150" height="70" as="geometry"/>
        </mxCell>

        <mxCell id="ingest_conv2" value="POST /v1/ingest/&#xa;conversation&#xa;&#xa;messages + session_id&#xa;+ reference_date" style="rounded=1;whiteSpace=wrap;fillColor=#e17055;fontColor=#ffffff;strokeColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="620" y="890" width="150" height="80" as="geometry"/>
        </mxCell>

        <mxCell id="m2i" style="strokeColor=#e17055;strokeWidth=1.5;" edge="1" parent="1" source="memory_md" target="ingest_text"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="d2i" style="strokeColor=#e17055;strokeWidth=1.5;" edge="1" parent="1" source="daily_logs" target="ingest_text"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="t2i" style="strokeColor=#e17055;strokeWidth=1.5;" edge="1" parent="1" source="transcripts" target="ingest_conv2"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- Cortex Knowledge Graph -->
        <mxCell id="cortex_db" value="Cortex Knowledge Graph&#xa;&#xa;9 node types:&#xa;FACT, ENTITY, EMOTION, INSIGHT&#xa;VALUE, BELIEF, LIFECONTEXT&#xa;SESSION, COMMUNITY&#xa;&#xa;7 edge types:&#xa;MENTIONS, BEFORE, SUPERSEDES&#xa;CONTRADICTS, SUPPORTS&#xa;ELABORATES, EXTRACTED_FROM&#xa;&#xa;PostgreSQL 16 + pgvector" style="shape=cylinder3;whiteSpace=wrap;boundedLbl=1;backgroundOutline=1;size=15;fillColor=#0984e3;fontColor=#ffffff;strokeColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="880" y="750" width="260" height="240" as="geometry"/>
        </mxCell>

        <mxCell id="i2db1" style="strokeColor=#e17055;strokeWidth=2;" edge="1" parent="1" source="ingest_text" target="cortex_db"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="i2db2" style="strokeColor=#e17055;strokeWidth=2;" edge="1" parent="1" source="ingest_conv2" target="cortex_db"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- Periodic Reflect -->
        <mxCell id="reflect" value="Periodic Reflect&#xa;&#xa;POST /v1/reflect&#xa;every 1hr (configurable)&#xa;&#xa;Cross-session synthesis&#xa;Merge related facts&#xa;Create SUPERSEDES edges&#xa;Detect contradictions" style="rounded=1;whiteSpace=wrap;fillColor=#0984e3;fontColor=#ffffff;strokeColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="1250" y="770" width="180" height="160" as="geometry"/>
        </mxCell>

        <mxCell id="r2db" style="strokeColor=#0984e3;strokeWidth=2;" edge="1" parent="1" source="reflect" target="cortex_db"><mxGeometry relative="1" as="geometry"/></mxCell>

        <!-- Retrieve arrow back from DB to recall -->
        <mxCell id="db2recall" value="scored memories" style="edgeStyle=orthogonalEdgeStyle;curved=1;strokeColor=#0984e3;strokeWidth=2;dashed=1;fontSize=10;" edge="1" parent="1" source="cortex_db" target="retrieve_call">
          <mxGeometry relative="1" as="geometry">
            <Array as="points">
              <mxPoint x="1010" y="720"/>
              <mxPoint x="320" y="720"/>
            </Array>
          </mxGeometry>
        </mxCell>

        <!-- PHASE 4: SHUTDOWN -->
        <mxCell id="shutdown_bg" value="" style="rounded=1;whiteSpace=wrap;fillColor=#f5f5f5;strokeColor=#636e72;strokeWidth=1;dashed=1;" vertex="1" parent="1">
          <mxGeometry x="40" y="1070" width="1520" height="100" as="geometry"/>
        </mxCell>

        <mxCell id="stop_watcher" value="Stop Watcher&#xa;&#xa;kill fs.watch&#xa;clear offsets" style="rounded=1;whiteSpace=wrap;fillColor=#636e72;fontColor=#ffffff;strokeColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="180" y="1080" width="140" height="70" as="geometry"/>
        </mxCell>

        <mxCell id="stop_reflect" value="Stop Reflect&#xa;&#xa;clear interval" style="rounded=1;whiteSpace=wrap;fillColor=#636e72;fontColor=#ffffff;strokeColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="420" y="1080" width="140" height="70" as="geometry"/>
        </mxCell>

        <mxCell id="stop_queue" value="Stop RetryQueue&#xa;&#xa;flush/drop pending" style="rounded=1;whiteSpace=wrap;fillColor=#636e72;fontColor=#ffffff;strokeColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="660" y="1080" width="140" height="70" as="geometry"/>
        </mxCell>

        <mxCell id="log_metrics" value="Log Metrics&#xa;&#xa;p50, p95, p99 latency&#xa;sample count" style="rounded=1;whiteSpace=wrap;fillColor=#636e72;fontColor=#ffffff;strokeColor=none;fontSize=10;" vertex="1" parent="1">
          <mxGeometry x="900" y="1080" width="140" height="70" as="geometry"/>
        </mxCell>

        <mxCell id="done" value="Done" style="ellipse;whiteSpace=wrap;fillColor=#636e72;fontColor=#ffffff;strokeColor=none;fontSize=14;fontStyle=1;" vertex="1" parent="1">
          <mxGeometry x="1180" y="1090" width="90" height="50" as="geometry"/>
        </mxCell>

        <mxCell id="sh1" style="edgeStyle=orthogonalEdgeStyle;strokeColor=#636e72;strokeWidth=1.5;" edge="1" parent="1" source="stop_watcher" target="stop_reflect"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="sh2" style="edgeStyle=orthogonalEdgeStyle;strokeColor=#636e72;strokeWidth=1.5;" edge="1" parent="1" source="stop_reflect" target="stop_queue"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="sh3" style="edgeStyle=orthogonalEdgeStyle;strokeColor=#636e72;strokeWidth=1.5;" edge="1" parent="1" source="stop_queue" target="log_metrics"><mxGeometry relative="1" as="geometry"/></mxCell>
        <mxCell id="sh4" style="edgeStyle=orthogonalEdgeStyle;strokeColor=#636e72;strokeWidth=1.5;" edge="1" parent="1" source="log_metrics" target="done"><mxGeometry relative="1" as="geometry"/></mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
